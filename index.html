<!DOCTYPE html>
<html lang="en">
<head>
   <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-18XR8R8MFP"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-18XR8R8MFP');
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyTimer.io - Visual Multi-Activity Timer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {}
            }
        }
    </script>
    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .animate-spin { animation: spin 1s linear infinite; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Ensure proper dark mode text contrast */
        .dark .text-slate-900 { color: rgb(241 245 249) !important; }
        .dark .text-slate-800 { color: rgb(248 250 252) !important; }
        .dark .text-slate-700 { color: rgb(226 232 240) !important; }
        .dark .text-slate-600 { color: rgb(203 213 225) !important; }
        .dark .text-black { color: white !important; }
        
        /* Hover effect for mint green buttons */
        .btn-mint:hover {
            background-color: #A8D5BF !important;
        }
        
        @media print {
            body { background-color: white !important; color: black !important; }
            nav, .print-hidden { display: none !important; }
            main { display: block !important; margin: 0 !important; padding: 0 !important; }
            section { box-shadow: none !important; border: none !important; margin-bottom: 20px !important; }
        }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 min-h-screen transition-colors duration-200">
    <div id="app"></div>

    <script>
        // Constants
        const COLORS = ['#6366f1', '#ef4444', '#10b981', '#f59e0b', '#8b5cf6', '#06b6d4', '#ec4899', '#f97316'];
        
        const PRESET_TEMPLATES = [
            {
                name: "Morning Routine",
                icon: "üåÖ",
                description: "Structure for a smooth start to the day.",
                activities: [
                    { name: "Wake & Stretch", duration: 5, color: '#10b981' },
                    { name: "Getting Ready", duration: 15, color: '#6366f1' },
                    { name: "Healthy Breakfast", duration: 20, color: '#f59e0b' },
                    { name: "Pack Bag", duration: 10, color: '#f97316' }
                ]
            },
            {
                name: "Study Session (Pomodoro)",
                icon: "üìö",
                description: "Optimized deep work cycles with restorative breaks.",
                activities: [
                    { name: "Deep Work Sprint", duration: 25, color: '#ef4444' },
                    { name: "Short Break", duration: 5, color: '#10b981' },
                    { name: "Review & Polish", duration: 25, color: '#ef4444' },
                    { name: "Wrap Up", duration: 10, color: '#8b5cf6' }
                ]
            },
            {
                name: "Classroom Transition",
                icon: "üè´",
                description: "Clear expectations for moving between lessons.",
                activities: [
                    { name: "Clean Up Station", duration: 3, color: '#f59e0b' },
                    { name: "Gather on Carpet", duration: 2, color: '#6366f1' },
                    { name: "Ready for Lesson", duration: 5, color: '#10b981' }
                ]
            }
        ];

        const AUDIO_URLS = {
            chime: 'https://actions.google.com/sounds/v1/alarms/digital_watch_alarm_long.ogg',
            bell: 'https://actions.google.com/sounds/v1/alarms/medium_bell_ringing_near.ogg',
            alert: 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg'
        };

        const AppMode = {
            PLANNING: 'PLANNING',
            RUNNING: 'RUNNING',
            SUMMARY: 'SUMMARY'
        };

        // Lucide icons as SVG strings
        const icons = {
            Play: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"></polygon></svg>',
            Pause: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="4" height="16" x="6" y="4"></rect><rect width="4" height="16" x="14" y="4"></rect></svg>',
            RotateCcw: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>',
            Plus: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"></path><path d="M12 5v14"></path></svg>',
            Trash2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" x2="10" y1="11" y2="17"></line><line x1="14" x2="14" y1="11" y2="17"></line></svg>',
            CheckCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            Clock: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            Coffee: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10 2v2"></path><path d="M14 2v2"></path><path d="M16 8a1 1 0 0 1 1 1v8a4 4 0 0 1-4 4H7a4 4 0 0 1-4-4V9a1 1 0 0 1 1-1h14a4 4 0 1 1 0 8h-1"></path><path d="M6 2v2"></path></svg>',
            LayoutGrid: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="3" rx="1"></rect><rect width="7" height="7" x="14" y="14" rx="1"></rect><rect width="7" height="7" x="3" y="14" rx="1"></rect></svg>',
            Settings2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 7h-9"></path><path d="M14 17H5"></path><circle cx="17" cy="17" r="3"></circle><circle cx="7" cy="7" r="3"></circle></svg>',
            X: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"></path><path d="m6 6 12 12"></path></svg>',
            Upload: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" x2="12" y1="3" y2="15"></line></svg>',
            Save: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>',
            Square: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="18" x="3" y="3" rx="2"></rect></svg>',
            CheckSquare: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>',
            BarChart3: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 3v18h18"></path><path d="M18 17V9"></path><path d="M13 17V5"></path><path d="M8 17v-3"></path></svg>',
            Brain: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"></path><path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"></path><path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"></path><path d="M17.599 6.5a3 3 0 0 0 .399-1.375"></path><path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"></path><path d="M3.477 10.896a4 4 0 0 1 .585-.396"></path><path d="M19.938 10.5a4 4 0 0 1 .585.396"></path><path d="M6 18a4 4 0 0 1-1.967-.516"></path><path d="M19.967 17.484A4 4 0 0 1 18 18"></path></svg>',
            Moon: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>',
            Sun: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>',
            Volume2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path><path d="M19.07 4.93a10 10 0 0 1 0 14.14"></path></svg>',
            Loader2: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>',
            Sparkles: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"></path><path d="M5 3v4"></path><path d="M19 17v4"></path><path d="M3 5h4"></path><path d="M17 19h4"></path></svg>',
            ClipboardList: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="8" height="4" x="8" y="2" rx="1" ry="1"></rect><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><path d="M12 11h4"></path><path d="M12 16h4"></path><path d="M8 11h.01"></path><path d="M8 16h.01"></path></svg>',
            PlayCircle: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg>',
            FileUp: '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path><polyline points="14 2 14 8 20 8"></polyline><path d="M12 12v6"></path><path d="m15 15-3-3-3 3"></path></svg>'
        };

        // Global State
        let state = {
            activities: [],
            mode: AppMode.PLANNING,
            viewMode: 'planner',
            currentIndex: 0,
            isRunning: false,
            insights: "",
            isDarkMode: false,
            isSettingsOpen: false,
            deleteConfirmation: null,
            customTemplates: [],
            isSavingTemplate: false,
            newTemplateName: "",
            selectedIds: new Set(),
            selectedSound: 'chime',
            volume: 0.5,
            defaultBreakDuration: 5,
            confirmBeforeDelete: true,
            now: new Date(),
            timerInterval: null,
            audioElement: null,
            dragItem: null,
            dragOverItem: null,
            fileInputRef: null
        };

        // Utility Functions
        function generateId() {
            return 'id-' + Math.random().toString(36).substr(2, 9) + Date.now().toString(36);
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function saveToLocalStorage() {
            localStorage.setItem('focusflow_activities', JSON.stringify(state.activities));
            localStorage.setItem('focusflow_volume', state.volume.toString());
            localStorage.setItem('focusflow_sound', state.selectedSound);
            localStorage.setItem('focusflow_break_dur', state.defaultBreakDuration.toString());
            localStorage.setItem('focusflow_custom_templates', JSON.stringify(state.customTemplates));
            localStorage.setItem('focusflow_confirm_delete', state.confirmBeforeDelete.toString());
            localStorage.setItem('focusflow_dark_mode', state.isDarkMode.toString());
        }

        function generateInsights() {
            if (state.activities.length === 0) {
                return "Ready to plan your day? Start by adding your first task. Breaking down your day into manageable activities helps reduce overwhelm and builds momentum.";
            }

            const totalMinutes = state.activities.reduce((sum, a) => sum + a.duration, 0);
            const activityCount = state.activities.length;
            const hasBreaks = state.activities.some(a => a.name.toLowerCase().includes('break'));
            const longestTask = Math.max(...state.activities.map(a => a.duration));
            const shortTasks = state.activities.filter(a => a.duration <= 15).length;
            const mediumTasks = state.activities.filter(a => a.duration > 15 && a.duration <= 45).length;
            const longTasks = state.activities.filter(a => a.duration > 45).length;

            let insights = [];

            // Total time insights
            if (totalMinutes > 180) {
                insights.push("You've planned an ambitious session‚Äîover 3 hours. Remember, sustained focus works best in chunks. Consider whether you can tackle this today or if splitting across multiple sessions would feel more achievable.");
            } else if (totalMinutes > 90) {
                insights.push("Your session is about " + Math.round(totalMinutes / 60 * 10) / 10 + " hours. This is a solid focused work block. You're setting yourself up for meaningful progress.");
            } else if (totalMinutes >= 30) {
                insights.push("A " + totalMinutes + "-minute session is perfectly sized for maintaining focus and building momentum. You've got this.");
            } else {
                insights.push("Short, focused sessions like this can be incredibly powerful. Even " + totalMinutes + " minutes of intentional work creates forward movement.");
            }

            // Break insights
            if (!hasBreaks && totalMinutes > 60) {
                insights.push("I notice you haven't scheduled any breaks yet. Your brain needs micro-rests to sustain attention. Consider adding a 5-minute break after every hour to maintain your mental sharpness.");
            } else if (hasBreaks) {
                insights.push("Great call including breaks. These moments of restoration aren't weakness‚Äîthey're strategic. Your future focused self will thank you.");
            }

            // Task structure insights
            if (longestTask > 60) {
                insights.push("Your longest task is " + longestTask + " minutes. If you find yourself avoiding it or feeling stuck, that might be a signal it needs breaking down further. What's the smallest first step you could start with?");
            }

            if (shortTasks > mediumTasks + longTasks && activityCount > 5) {
                insights.push("You've broken things into many small tasks‚Äîthat's excellent for executive function. Each completion gives you a dopamine hit and reinforces your momentum. The cascade of small wins often matters more than one big accomplishment.");
            }

            if (longTasks >= 3) {
                insights.push("Several longer tasks here. Remember: you don't have to feel motivated to begin. Motivation often follows action, not the other way around. Start with just 5 minutes, and notice what happens.");
            }

            // Activity count insights
            if (activityCount === 1) {
                insights.push("Single-tasking‚Äîthere's power in this simplicity. When you're only focusing on one thing, you eliminate decision fatigue. Just this, right now.");
            } else if (activityCount <= 3) {
                insights.push("A focused session with " + activityCount + " clear priorities. This level of intentionality is where productivity becomes sustainable rather than exhausting.");
            } else if (activityCount > 8) {
                insights.push("You've mapped out quite a few activities. Be gentle with yourself if you don't complete everything‚Äîflexibility is part of the process. What matters most if you can only finish half?");
            }

            // Motivational and executive function insights
            const motivationalInsights = [
                "Starting is often the hardest part. Once you begin, your brain's task-switching costs decrease and you'll find your rhythm. That first minute is an investment in the next 59.",
                "Notice: you're already here, planning. That's executive function in action. The fact that you're structuring your time means you're already succeeding at something many people struggle with.",
                "If you feel resistance, that's normal. Your brain is weighing effort against reward. Sometimes we just need to gently override that initial 'no' and trust the process.",
                "These aren't just tasks‚Äîthey're commitments to your future self. Each one completed is evidence that you can trust yourself to follow through.",
                "Perfect conditions rarely exist. Starting where you are, with what you have, is the actual skill. You're building that skill right now.",
            ];

            insights.push(motivationalInsights[Math.floor(Math.random() * motivationalInsights.length)]);

            // Time-of-day contextual insights
            const hour = new Date().getHours();
            if (hour >= 6 && hour < 10) {
                insights.push("Morning energy is often your clearest cognitive window. If possible, front-load your most demanding work now while your mental resources are fresh.");
            } else if (hour >= 14 && hour < 16) {
                insights.push("Afternoon attention naturally dips around now. This is normal circadian biology. If you're feeling fuzzy, a 5-minute walk or stretching can reset your focus more than caffeine.");
            } else if (hour >= 20 && hour < 24) {
                insights.push("Evening sessions work differently than morning ones. Your analytical mind might be tired, but creative or maintenance tasks can flow easily now. Honor where your energy is.");
            }

            // Return 2-3 randomly selected insights for variety
            const selectedInsights = [];
            const shuffled = insights.sort(() => 0.5 - Math.random());
            const numInsights = Math.min(3, shuffled.length);
            
            for (let i = 0; i < numInsights; i++) {
                selectedInsights.push(shuffled[i]);
            }

            return selectedInsights.join(' ');
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('focusflow_activities');
            const savedVol = localStorage.getItem('focusflow_volume');
            const savedSound = localStorage.getItem('focusflow_sound');
            const savedBreakDur = localStorage.getItem('focusflow_break_dur');
            const savedCustomTemplates = localStorage.getItem('focusflow_custom_templates');
            const savedConfirmDelete = localStorage.getItem('focusflow_confirm_delete');
            const savedDarkMode = localStorage.getItem('focusflow_dark_mode');

            if (savedVol) state.volume = parseFloat(savedVol);
            if (savedBreakDur) state.defaultBreakDuration = parseInt(savedBreakDur);
            if (savedSound && AUDIO_URLS[savedSound]) state.selectedSound = savedSound;
            if (savedCustomTemplates) {
                try { state.customTemplates = JSON.parse(savedCustomTemplates); } catch (e) { }
            }
            if (savedConfirmDelete !== null) {
                state.confirmBeforeDelete = savedConfirmDelete === 'true';
            }

            let darkModeValue = false;
            if (savedDarkMode !== null) {
                darkModeValue = savedDarkMode === 'true';
            } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                darkModeValue = true;
            }
            state.isDarkMode = darkModeValue;

            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state.activities = parsed.map(a => ({
                        ...a,
                        completed: false,
                        remainingSeconds: a.duration * 60
                    }));
                } catch (e) { }
            }
        }

        // Core Functions
        function addActivity() {
            const newId = generateId();
            const duration = 15;
            const colorIndex = state.activities.length % COLORS.length;
            state.activities.push({
                id: newId,
                name: "",
                duration: duration,
                color: COLORS[colorIndex],
                completed: false,
                remainingSeconds: duration * 60
            });
            state.insights = generateInsights();
            saveToLocalStorage();
            render();
            
            requestAnimationFrame(() => {
                const input = document.getElementById(`activity-input-${newId}`);
                if (input) {
                    input.focus();
                }
            });
        }

        function addBreak() {
            const newId = generateId();
            state.activities.push({
                id: newId,
                name: "Break",
                duration: state.defaultBreakDuration,
                color: '#10b981',
                completed: false,
                remainingSeconds: state.defaultBreakDuration * 60
            });
            state.insights = generateInsights();
            saveToLocalStorage();
            render();
        }

        function updateActivity(id, updates) {
            const index = state.activities.findIndex(a => a.id === id);
            if (index !== -1) {
                state.activities[index] = { ...state.activities[index], ...updates };
                if (updates.duration !== undefined) {
                    state.activities[index].remainingSeconds = updates.duration * 60;
                    state.insights = generateInsights();
                }
                saveToLocalStorage();
                if (updates.duration !== undefined) {
                    render();
                }
            }
        }

        let nameInputTimeout = null;
        let isTyping = false;
        
        function handleActivityNameChange(id, value) {
            isTyping = true;
            
            const index = state.activities.findIndex(a => a.id === id);
            if (index !== -1) {
                state.activities[index].name = value;
                saveToLocalStorage();
            }
            
            clearTimeout(nameInputTimeout);
            nameInputTimeout = setTimeout(() => {
                state.insights = generateInsights();
                updateInsightsDisplay();
                isTyping = false;
            }, 2000);
        }

        function handleInputFocus(id) {
            isTyping = true;
            const input = document.getElementById(`activity-input-${id}`);
            if (input && input.value && input.value !== 'Untitled Activity') {
                input.dataset.originalValue = input.value;
                setTimeout(() => {
                    input.select();
                }, 10);
            }
        }

        function handleInputKeydown(event, id) {
            const input = document.getElementById(`activity-input-${id}`);
            
            if (event.key === 'Enter') {
                event.preventDefault();
                isTyping = false;
                input.blur();
            } else if (event.key === 'Escape') {
                event.preventDefault();
                if (input.dataset.originalValue) {
                    input.value = input.dataset.originalValue;
                    const index = state.activities.findIndex(a => a.id === id);
                    if (index !== -1) {
                        state.activities[index].name = input.dataset.originalValue;
                        saveToLocalStorage();
                    }
                }
                isTyping = false;
                input.blur();
            }
        }

        function handleInputBlur(id) {
            isTyping = false;
            
            const input = document.getElementById(`activity-input-${id}`);
            const index = state.activities.findIndex(a => a.id === id);
            if (index !== -1 && !state.activities[index].name.trim()) {
                state.activities[index].name = "Untitled Activity";
                saveToLocalStorage();
                if (input) {
                    input.value = "Untitled Activity";
                }
            }
            
            state.insights = generateInsights();
            updateInsightsDisplay();
        }

        function updateInsightsDisplay() {
            const insightElements = document.querySelectorAll('.coach-insights-text');
            insightElements.forEach(el => {
                el.textContent = state.insights || "Add activities to receive personalized insights and coaching.";
            });
        }

        function deleteActivity(id) {
            state.activities = state.activities.filter(a => a.id !== id);
            state.selectedIds.delete(id);
            state.insights = generateInsights();
            saveToLocalStorage();
            render();
        }

        function deleteSelected() {
            state.activities = state.activities.filter(a => !state.selectedIds.has(a.id));
            state.selectedIds.clear();
            state.insights = generateInsights();
            saveToLocalStorage();
            render();
        }

        function requestDelete(id) {
            if (state.confirmBeforeDelete) {
                state.deleteConfirmation = id;
                render();
            } else {
                if (Array.isArray(id)) {
                    deleteSelected();
                } else {
                    deleteActivity(id);
                }
            }
        }

        function confirmDelete() {
            if (Array.isArray(state.deleteConfirmation)) {
                deleteSelected();
            } else {
                deleteActivity(state.deleteConfirmation);
            }
            state.deleteConfirmation = null;
            render();
        }

        function cancelDelete() {
            state.deleteConfirmation = null;
            render();
        }

        function toggleSelect(id) {
            if (state.selectedIds.has(id)) {
                state.selectedIds.delete(id);
            } else {
                state.selectedIds.add(id);
            }
            render();
        }

        function toggleSelectAll() {
            if (state.selectedIds.size === state.activities.length) {
                state.selectedIds.clear();
            } else {
                state.selectedIds = new Set(state.activities.map(a => a.id));
            }
            render();
        }

        function startSession() {
            if (state.activities.length === 0) return;
            
            state.mode = AppMode.RUNNING;
            state.viewMode = 'timer';
            state.currentIndex = 0;
            state.isRunning = true;
            
            state.activities = state.activities.map(a => ({
                ...a,
                completed: false,
                remainingSeconds: a.duration * 60
            }));
            
            startTimer();
            render();
        }

        function startTimer() {
            if (state.timerInterval) clearInterval(state.timerInterval);
            
            state.timerInterval = setInterval(() => {
                if (!state.isRunning || state.currentIndex >= state.activities.length) {
                    stopTimer();
                    return;
                }

                const current = state.activities[state.currentIndex];
                if (current.remainingSeconds > 0) {
                    current.remainingSeconds--;
                    render();
                } else {
                    playSound();
                    current.completed = true;
                    
                    const nextIncomplete = state.activities.findIndex((a, i) => i > state.currentIndex && !a.completed);
                    
                    if (nextIncomplete !== -1) {
                        state.currentIndex = nextIncomplete;
                    } else {
                        state.mode = AppMode.SUMMARY;
                        state.isRunning = false;
                        stopTimer();
                    }
                    
                    saveToLocalStorage();
                    render();
                }
            }, 1000);
        }

        function stopTimer() {
            if (state.timerInterval) {
                clearInterval(state.timerInterval);
                state.timerInterval = null;
            }
        }

        function togglePause() {
            state.isRunning = !state.isRunning;
            if (state.isRunning) {
                startTimer();
            } else {
                stopTimer();
            }
            render();
        }

        function resetSession() {
            stopTimer();
            state.mode = AppMode.PLANNING;
            state.viewMode = 'planner';
            state.currentIndex = 0;
            state.isRunning = false;
            state.activities = state.activities.map(a => ({
                ...a,
                completed: false,
                remainingSeconds: a.duration * 60
            }));
            saveToLocalStorage();
            render();
        }

        function skipActivity() {
            if (state.currentIndex >= state.activities.length - 1) {
                state.mode = AppMode.SUMMARY;
                state.isRunning = false;
                stopTimer();
            } else {
                state.activities[state.currentIndex].completed = true;
                const nextIncomplete = state.activities.findIndex((a, i) => i > state.currentIndex && !a.completed);
                if (nextIncomplete !== -1) {
                    state.currentIndex = nextIncomplete;
                } else {
                    state.mode = AppMode.SUMMARY;
                    state.isRunning = false;
                    stopTimer();
                }
            }
            saveToLocalStorage();
            render();
        }

        function playSound() {
            if (state.audioElement) {
                state.audioElement.pause();
                state.audioElement.currentTime = 0;
                state.audioElement.volume = state.volume;
                state.audioElement.play().catch(e => console.error("Playback failed", e));
                
                setTimeout(() => {
                    if (state.audioElement) {
                        state.audioElement.pause();
                    }
                }, 5000);
            }
        }

        function handleSoundChange(newSound) {
            state.selectedSound = newSound;
            if (state.audioElement) {
                state.audioElement.src = AUDIO_URLS[newSound];
                state.audioElement.load();
            }
            saveToLocalStorage();
            // Don't render immediately - let the dropdown close naturally
            // The settings modal will show the updated value on next interaction
            
            // Play preview sound
            setTimeout(() => {
                if (state.audioElement) {
                    state.audioElement.volume = state.volume;
                    state.audioElement.play().catch(e => console.error("Playback failed", e));
                    setTimeout(() => {
                        if (state.audioElement) {
                            state.audioElement.pause();
                            state.audioElement.currentTime = 0;
                        }
                    }, 1500);
                }
            }, 100);
        }

        function loadPreset(preset) {
            state.activities = preset.activities.map(a => ({
                id: generateId(),
                name: a.name,
                duration: a.duration,
                color: a.color,
                completed: false,
                remainingSeconds: a.duration * 60
            }));
            state.insights = generateInsights();
            saveToLocalStorage();
            render();
        }

        function toggleDarkMode() {
            state.isDarkMode = !state.isDarkMode;
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
            saveToLocalStorage();
            render();
        }

        function navigateToPlanner() {
            state.viewMode = 'planner';
            render();
        }

        function navigateToTimer() {
            if (state.mode === AppMode.RUNNING) {
                state.viewMode = 'timer';
            } else {
                if (state.activities.length > 0) {
                    startSession();
                    state.viewMode = 'timer';
                }
            }
            render();
        }



        function handleSort() {
            if (state.dragItem === null || state.dragOverItem === null) return;
            
            const items = [...state.activities];
            const draggedItem = items[state.dragItem];
            items.splice(state.dragItem, 1);
            items.splice(state.dragOverItem, 0, draggedItem);
            
            state.activities = items;
            state.dragItem = null;
            state.dragOverItem = null;
            
            saveToLocalStorage();
            render();
        }

        // Visual Timer Component
        function createVisualTimer() {
            const radius = 100;
            const viewBoxSize = 240;
            const center = viewBoxSize / 2;
            
            const now = state.now;
            const seconds = now.getSeconds();
            const currentMinutes = now.getMinutes() + seconds / 60;
            const currentHours = (now.getHours() % 12) + currentMinutes / 60;

            const getCoordinatesForPercent = (percent, r = radius) => {
                const x = Math.cos(2 * Math.PI * percent - Math.PI / 2);
                const y = Math.sin(2 * Math.PI * percent - Math.PI / 2);
                return [x * r + center, y * r + center];
            };

            const hourScale = 60;
            let cumulativeMinutesOffset = currentMinutes;

            let wedgesHtml = '';
            state.activities.forEach((activity, index) => {
                let wedgeDurationMinutes = 0;
                if (activity.completed) {
                    wedgeDurationMinutes = 0;
                } else if (state.isRunning && index === state.currentIndex) {
                    wedgeDurationMinutes = activity.remainingSeconds / 60;
                } else if (state.isRunning && index < state.currentIndex) {
                    wedgeDurationMinutes = 0;
                } else {
                    wedgeDurationMinutes = activity.duration;
                }

                if (wedgeDurationMinutes <= 0) return;

                const startPercent = cumulativeMinutesOffset / hourScale;
                const endPercent = (cumulativeMinutesOffset + wedgeDurationMinutes) / hourScale;
                
                const [startX, startY] = getCoordinatesForPercent(startPercent);
                const [endX, endY] = getCoordinatesForPercent(endPercent);
                
                const largeArcFlag = wedgeDurationMinutes / hourScale > 0.5 ? 1 : 0;
                const pathData = [
                    `M ${center} ${center}`,
                    `L ${startX} ${startY}`,
                    `A ${radius} ${radius} 0 ${largeArcFlag} 1 ${endX} ${endY}`,
                    'Z'
                ].join(' ');

                cumulativeMinutesOffset += wedgeDurationMinutes;

                wedgesHtml += `<path d="${pathData}" fill="${activity.color}" class="transition-all duration-300 opacity-60 hover:opacity-80" stroke="white" stroke-width="0.5" />`;
            });

            let minuteHashes = '';
            for (let i = 0; i < 60; i++) {
                const angle = (i * 6 * Math.PI) / 180;
                const innerR = i % 5 === 0 ? radius - 8 : radius - 4;
                const outerR = radius;
                const strokeClass = i % 5 === 0 ? "stroke-slate-400" : "stroke-slate-200";
                const strokeWidth = i % 5 === 0 ? 2 : 1;
                
                minuteHashes += `<line x1="${Math.cos(angle - Math.PI / 2) * innerR + center}" y1="${Math.sin(angle - Math.PI / 2) * innerR + center}" x2="${Math.cos(angle - Math.PI / 2) * outerR + center}" y2="${Math.sin(angle - Math.PI / 2) * outerR + center}" class="${strokeClass}" stroke-width="${strokeWidth}" />`;
            }

            let clockNumbers = '';
            for (let i = 0; i < 12; i++) {
                const num = i + 1;
                const angle = (num * 30 * Math.PI) / 180;
                const textR = radius - 22;
                const x = Math.cos(angle - Math.PI / 2) * textR + center;
                const y = Math.sin(angle - Math.PI / 2) * textR + center;
                
                clockNumbers += `<text x="${x}" y="${y}" text-anchor="middle" dominant-baseline="middle" class="fill-slate-500 dark:fill-slate-400 font-bold text-[10px] select-none">${num}</text>`;
            }

            return `
                <div class="relative w-full max-w-md mx-auto aspect-square">
                    <svg viewBox="0 0 ${viewBoxSize} ${viewBoxSize}" class="w-full h-full drop-shadow-2xl">
                        <circle cx="${center}" cy="${center}" r="${radius + 8}" class="fill-white dark:fill-slate-800 stroke-slate-200 dark:stroke-slate-700" stroke-width="2" />
                        ${minuteHashes}
                        ${clockNumbers}
                        ${wedgesHtml}
                        <line x1="${center}" y1="${center}" x2="${center + Math.cos((currentHours * 30 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.5)}" y2="${center + Math.sin((currentHours * 30 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.5)}" class="stroke-slate-800 dark:stroke-slate-200" stroke-width="4" stroke-linecap="round" />
                        <line x1="${center}" y1="${center}" x2="${center + Math.cos((currentMinutes * 6 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.8)}" y2="${center + Math.sin((currentMinutes * 6 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.8)}" class="stroke-indigo-600 dark:stroke-indigo-400" stroke-width="3" stroke-linecap="round" />
                        <line x1="${center}" y1="${center}" x2="${center + Math.cos((seconds * 6 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.9)}" y2="${center + Math.sin((seconds * 6 * Math.PI) / 180 - Math.PI / 2) * (radius * 0.9)}" class="stroke-red-500" stroke-width="1.5" stroke-linecap="round" />
                        <circle cx="${center}" cy="${center}" r="4" class="fill-slate-800 dark:fill-white" />
                        <circle cx="${center}" cy="${center}" r="1.5" class="fill-red-500" />
                    </svg>
                </div>
            `;
        }

        // Stats Card Component
        function createStatsCard(label, value, iconName, colorClass) {
            return `
                <div class="bg-white dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 shadow-sm flex items-center gap-4">
                    <div class="p-3 rounded-xl ${colorClass}">
                        ${icons[iconName]}
                    </div>
                    <div>
                        <p class="text-sm font-medium text-slate-500 dark:text-slate-400">${label}</p>
                        <p class="text-xl font-bold text-slate-900 dark:text-white">${value}</p>
                    </div>
                </div>
            `;
        }

        // Main Render Function
        function render() {
            const scrollContainer = document.getElementById('activities-scroll-container');
            const scrollTop = scrollContainer ? scrollContainer.scrollTop : 0;
            const activeElement = document.activeElement;
            const activeId = activeElement?.id;
            const cursorPosition = activeElement?.selectionStart;
            
            const totalMinutes = state.activities.reduce((sum, a) => sum + a.duration, 0);
            const completedCount = state.activities.filter(a => a.completed).length;
            const currentActivity = state.activities[state.currentIndex];

            let mainContent = '';

            const displayMode = state.viewMode === 'timer' && state.mode === AppMode.RUNNING ? 'RUNNING' : 
                                state.mode === AppMode.SUMMARY ? 'SUMMARY' : 'PLANNING';

            if (displayMode === 'PLANNING') {
                mainContent = `
                    <div class="lg:grid lg:grid-cols-12 gap-8 flex flex-col">
                        <div class="lg:col-span-7 space-y-8">
                            <section class="bg-gradient-to-br from-emerald-50 to-orange-50 dark:from-slate-900 dark:to-orange-950/30 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-8">
                                ${createVisualTimer()}
                                <div class="mt-6 text-center">
                                    <p class="text-sm font-semibold text-slate-500 dark:text-slate-400 mb-2">READY TO BEGIN</p>
                                    <p class="text-lg font-bold text-slate-900 dark:text-white">${state.activities.length} Activities ‚Ä¢ ${totalMinutes} minutes</p>
                                </div>
                            </section>

                            <div class="grid grid-cols-2 gap-4">
                                ${createStatsCard('Total Time', `${totalMinutes} min`, 'Clock', 'bg-blue-50 dark:bg-blue-950 text-blue-600 dark:text-blue-400')}
                                ${createStatsCard('Activities', state.activities.length, 'BarChart3', 'bg-emerald-50 dark:bg-emerald-950 text-emerald-600 dark:text-emerald-400')}
                            </div>

                            ${state.activities.length > 0 ? `
                            <button onclick="startSession()" class="btn-mint w-full flex items-center justify-center gap-3 px-8 py-4 text-lg font-extrabold rounded-2xl shadow-lg hover:shadow-xl transition-all active:scale-[0.98]" style="background-color: #C2E5D3; color: #1e293b;">
                                ${icons.Play} START SESSION
                            </button>
                            ` : ''}

                            <section class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-6 order-3 lg:order-1">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background-color: #C2E5D3; color: #1e293b;">
                                        ${icons.Brain}
                                    </div>
                                    <h3 class="font-bold text-lg text-slate-900 dark:text-white">Coach Insights</h3>
                                </div>
                                <p class="coach-insights-text text-slate-600 dark:text-slate-300 leading-relaxed">
                                    ${state.insights || "Add activities to receive personalized insights and coaching."}
                                </p>
                            </section>
                        </div>

                        <div class="lg:col-span-5 flex flex-col gap-6">
                            <section class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-6 order-1">
                                <h3 class="font-bold text-lg mb-4 flex items-center gap-2 text-slate-900 dark:text-white">
                                    ${icons.Sparkles} Quick Start Templates
                                </h3>
                                <div class="space-y-3">
                                    ${[...PRESET_TEMPLATES, ...state.customTemplates].map(preset => `
                                        <button onclick="loadPreset(${JSON.stringify(preset).replace(/"/g, '&quot;')})" class="w-full text-left p-4 bg-slate-50 dark:bg-slate-800 rounded-xl hover:bg-slate-100 dark:hover:bg-slate-700 transition-colors border border-slate-100 dark:border-slate-700">
                                            <div class="flex items-start gap-3">
                                                <div class="text-2xl">${preset.icon}</div>
                                                <div class="flex-1">
                                                    <p class="font-bold text-sm text-slate-900 dark:text-white">${preset.name}</p>
                                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-1">${preset.description}</p>
                                                </div>
                                            </div>
                                        </button>
                                    `).join('')}
                                </div>
                            </section>

                            <section class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm flex-1 flex flex-col relative overflow-hidden order-2">
                                <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm z-10">
                                    <div class="flex items-center gap-3">
                                        ${state.activities.length > 0 ? `
                                        <button onclick="toggleSelectAll()" class="p-1 text-slate-400 hover:text-indigo-600 transition-colors">
                                            ${state.selectedIds.size === state.activities.length ? icons.CheckSquare : icons.Square}
                                        </button>
                                        ` : ''}
                                        <h3 class="font-bold text-lg text-slate-900 dark:text-white">Planner</h3>
                                    </div>
                                    
                                    <div class="flex gap-2 print-hidden">
                                        ${state.selectedIds.size > 0 ? `
                                        <button onclick="requestDelete(Array.from(state.selectedIds))" class="p-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition-all active:scale-95">
                                            ${icons.Trash2}
                                        </button>
                                        ` : ''}
                                        <button onclick="addBreak()" class="flex items-center gap-1.5 px-3 py-1.5 bg-emerald-50 dark:bg-emerald-950/50 text-emerald-600 dark:text-emerald-400 text-xs font-bold rounded-xl border border-emerald-100 dark:border-emerald-900 hover:bg-emerald-100 transition-all active:scale-95">
                                            ${icons.Coffee} BREAK
                                        </button>
                                        <button onclick="addActivity()" class="p-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition-all active:scale-95 shadow-lg shadow-indigo-100">
                                            ${icons.Plus}
                                        </button>
                                    </div>
                                </div>

                                <div id="activities-scroll-container" class="flex-1 overflow-y-auto p-4 max-h-[400px]">
                                    ${state.activities.length === 0 ? `
                                    <div class="h-full flex flex-col items-center justify-center py-12 text-slate-400 text-center px-6">
                                        <div class="bg-slate-50 dark:bg-slate-800 p-4 rounded-full mb-4">
                                            ${icons.LayoutGrid}
                                        </div>
                                        <p class="font-medium text-slate-500 dark:text-slate-400">Empty Planner</p>
                                        <p class="text-xs mt-1">Add activities or use templates.</p>
                                    </div>
                                    ` : `
                                    <div class="space-y-3">
                                        ${state.activities.map((activity, index) => `
                                        <div 
                                            draggable="true"
                                            ondragstart="state.dragItem = ${index}"
                                            ondragenter="state.dragOverItem = ${index}"
                                            ondragend="handleSort()"
                                            ondragover="event.preventDefault()"
                                            class="group relative flex items-start gap-3 p-4 rounded-2xl border transition-all ${state.selectedIds.has(activity.id) ? 'border-emerald-500 bg-emerald-50/30 dark:bg-emerald-950/30' : 'bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700 hover:border-slate-200 dark:hover:border-slate-600'} ${activity.completed ? 'grayscale opacity-50' : ''} ${!activity.name ? 'border-dashed border-slate-300 dark:border-slate-600' : ''}"
                                        >
                                            <button onclick="toggleSelect('${activity.id}')" class="mt-1 text-slate-300 hover:text-indigo-600 transition-colors">
                                                ${state.selectedIds.has(activity.id) ? icons.CheckSquare : icons.Square}
                                            </button>

                                            <div class="flex-1 flex flex-col gap-2">
                                                <div class="flex items-center gap-2 group/edit">
                                                    <div class="w-3 h-3 rounded-full shrink-0" style="background-color: ${activity.color}"></div>
                                                    <div class="flex-1 relative">
                                                        <input 
                                                            id="activity-input-${activity.id}"
                                                            type="text"
                                                            class="w-full bg-transparent font-bold focus:outline-none focus:ring-2 focus:ring-emerald-400/50 dark:focus:ring-emerald-500/50 rounded px-2 py-1 text-sm text-slate-900 dark:text-white placeholder:text-slate-400 dark:placeholder:text-slate-500"
                                                            value="${activity.name}"
                                                            oninput="handleActivityNameChange('${activity.id}', this.value)"
                                                            onfocus="handleInputFocus('${activity.id}')"
                                                            onblur="handleInputBlur('${activity.id}')"
                                                            onkeydown="handleInputKeydown(event, '${activity.id}')"
                                                            placeholder="Type activity name..."
                                                        />
                                                        <svg class="w-3.5 h-3.5 absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 dark:text-slate-500 opacity-0 group-hover/edit:opacity-100 transition-opacity pointer-events-none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                                        </svg>
                                                    </div>
                                                </div>
                                                
                                                <div class="flex items-center gap-2">
                                                    <button 
                                                        onclick="updateActivity('${activity.id}', { duration: Math.max(1, ${activity.duration} - 1) })"
                                                        class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-all active:scale-95 text-slate-600 dark:text-slate-300 font-bold"
                                                        title="Decrease by 1 minute"
                                                    >
                                                        ‚àí
                                                    </button>
                                                    <div class="flex items-center gap-1.5 bg-slate-100 dark:bg-slate-700 px-3 py-2 rounded-lg">
                                                        <span class="w-4 h-4 text-slate-500 dark:text-slate-400">${icons.Clock}</span>
                                                        <input 
                                                            type="number"
                                                            inputmode="numeric"
                                                            pattern="[0-9]*"
                                                            class="w-12 bg-transparent focus:outline-none focus:ring-2 focus:ring-indigo-500 rounded text-center text-sm font-bold text-slate-900 dark:text-slate-100 px-1"
                                                            value="${activity.duration}"
                                                            onchange="updateActivity('${activity.id}', { duration: parseInt(this.value) || 0 })"
                                                            min="1"
                                                            max="999"
                                                        />
                                                        <span class="text-xs font-medium text-slate-500 dark:text-slate-400">min</span>
                                                    </div>
                                                    <button 
                                                        onclick="updateActivity('${activity.id}', { duration: ${activity.duration} + 1 })"
                                                        class="w-8 h-8 flex items-center justify-center bg-slate-100 dark:bg-slate-700 hover:bg-slate-200 dark:hover:bg-slate-600 rounded-lg transition-all active:scale-95 text-slate-600 dark:text-slate-300 font-bold"
                                                        title="Increase by 1 minute"
                                                    >
                                                        +
                                                    </button>
                                                </div>
                                            </div>

                                            <button onclick="requestDelete('${activity.id}')" class="text-slate-200 group-hover:text-red-400 p-1 transition-colors active:scale-90">
                                                ${icons.Trash2}
                                            </button>
                                        </div>
                                        `).join('')}
                                    </div>
                                    `}
                                </div>
                            </section>
                        </div>
                    </div>
                `;
            } else if (displayMode === 'RUNNING') {
                mainContent = `
                    <div class="max-w-4xl mx-auto space-y-8">
                        <section class="bg-gradient-to-br from-emerald-50 to-orange-50 dark:from-slate-900 dark:to-orange-950/30 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-8">
                            ${createVisualTimer()}
                            
                            <div class="mt-8 text-center space-y-4">
                                <div class="flex items-center justify-center gap-2">
                                    <div class="w-3 h-3 rounded-full" style="background-color: ${currentActivity.color}"></div>
                                    <h2 class="text-2xl font-extrabold text-slate-900 dark:text-white">${currentActivity.name}</h2>
                                </div>
                                
                                <div class="text-6xl font-mono font-extrabold text-indigo-600 dark:text-indigo-400">
                                    ${formatTime(currentActivity.remainingSeconds)}
                                </div>
                                
                                <p class="text-sm font-medium text-slate-500 dark:text-slate-400">
                                    Activity ${state.currentIndex + 1} of ${state.activities.length} ‚Ä¢ ${completedCount} completed
                                </p>
                            </div>

                            <div class="flex gap-3 mt-8">
                                <button onclick="togglePause()" class="btn-mint flex-1 flex items-center justify-center gap-2 px-6 py-4 font-bold rounded-xl transition-all shadow-lg active:scale-[0.98]" style="background-color: #C2E5D3; color: #1e293b;">
                                    ${state.isRunning ? icons.Pause : icons.Play}
                                    ${state.isRunning ? 'PAUSE' : 'RESUME'}
                                </button>
                                <button onclick="skipActivity()" class="px-6 py-4 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95">
                                    SKIP
                                </button>
                                <button onclick="resetSession()" class="px-6 py-4 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all active:scale-95">
                                    ${icons.RotateCcw}
                                </button>
                            </div>
                        </section>

                        <section class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-6">
                            <h3 class="font-bold text-lg mb-4 text-slate-900 dark:text-white">Up Next</h3>
                            <div class="space-y-2">
                                ${state.activities.map((activity, index) => `
                                <div class="flex items-center gap-3 p-3 rounded-xl ${index === state.currentIndex ? 'bg-indigo-50 dark:bg-indigo-950 border-2 border-indigo-200 dark:border-indigo-800' : 'bg-slate-50 dark:bg-slate-800'} ${activity.completed ? 'opacity-50' : ''}">
                                    <div class="w-3 h-3 rounded-full" style="background-color: ${activity.color}"></div>
                                    <span class="flex-1 font-medium text-sm text-slate-900 dark:text-white">${activity.name}</span>
                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">${activity.duration} min</span>
                                    ${activity.completed ? icons.CheckCircle : ''}
                                </div>
                                `).join('')}
                            </div>
                        </section>
                    </div>
                `;
            } else if (displayMode === 'SUMMARY') {
                const completionRate = state.activities.length > 0 ? Math.round((completedCount / state.activities.length) * 100) : 0;
                
                mainContent = `
                    <div class="max-w-3xl mx-auto space-y-8">
                        <section class="bg-gradient-to-br from-green-50 to-emerald-50 dark:from-slate-900 dark:to-emerald-950 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-8 text-center">
                            <div class="w-20 h-20 mx-auto mb-4 rounded-full bg-gradient-to-br from-green-500 to-emerald-600 flex items-center justify-center text-white">
                                ${icons.CheckCircle}
                            </div>
                            <h2 class="text-3xl font-extrabold text-slate-900 dark:text-white mb-2">Session Complete!</h2>
                            <p class="text-lg text-slate-600 dark:text-slate-300">Great work on completing your activities.</p>
                        </section>

                        <div class="grid grid-cols-3 gap-4">
                            ${createStatsCard('Completed', completedCount, 'CheckCircle', 'bg-green-50 dark:bg-green-950 text-green-600 dark:text-green-400')}
                            ${createStatsCard('Total Time', `${totalMinutes} min`, 'Clock', 'bg-blue-50 dark:bg-blue-950 text-blue-600 dark:text-blue-400')}
                            ${createStatsCard('Rate', `${completionRate}%`, 'BarChart3', 'bg-emerald-50 dark:bg-emerald-950 text-emerald-600 dark:text-emerald-400')}
                        </div>

                        <section class="bg-white dark:bg-slate-900 rounded-3xl border border-slate-100 dark:border-slate-800 shadow-sm p-6">
                            <h3 class="font-bold text-lg mb-4 text-slate-900 dark:text-white">Activity Summary</h3>
                            <div class="space-y-2">
                                ${state.activities.map(activity => `
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-slate-50 dark:bg-slate-800">
                                    <div class="w-3 h-3 rounded-full" style="background-color: ${activity.color}"></div>
                                    <span class="flex-1 font-medium text-sm text-slate-900 dark:text-white">${activity.name}</span>
                                    <span class="text-xs font-bold text-slate-500 dark:text-slate-400">${activity.duration} min</span>
                                    ${activity.completed ? `<span class="text-green-600 dark:text-green-400">${icons.CheckCircle}</span>` : ''}
                                </div>
                                `).join('')}
                            </div>
                        </section>

                        <button onclick="resetSession()" class="w-full flex items-center justify-center gap-3 px-8 py-4 bg-gradient-to-r from-emerald-600 to-orange-500 text-white text-lg font-extrabold rounded-2xl shadow-lg shadow-emerald-200 dark:shadow-emerald-900/50 hover:shadow-xl transition-all active:scale-[0.98]">
                            ${icons.RotateCcw} PLAN NEW SESSION
                        </button>
                    </div>
                `;
            }

            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="min-h-screen pb-12">
                    <nav class="bg-white dark:bg-slate-900 border-b border-slate-100 dark:border-slate-800 sticky top-0 z-50 backdrop-blur-sm bg-white/80 dark:bg-slate-900/80 print-hidden">
                        <div class="container mx-auto px-4 py-4 flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-xl flex items-center justify-center font-bold" style="background-color: #C2E5D3; color: #1e293b;">
                                    ${icons.Clock}
                                </div>
                                <h1 class="text-xl font-extrabold text-slate-900 dark:text-white">MyTimer.io</h1>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                ${state.mode === AppMode.RUNNING || state.mode === AppMode.SUMMARY ? `
                                <button onclick="navigateToTimer()" class="p-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors ${state.viewMode === 'timer' ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' : ''}" title="Go to Timer">
                                    ${icons.PlayCircle}
                                </button>
                                ` : ''}
                                <button onclick="navigateToPlanner()" class="p-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors ${state.viewMode === 'planner' ? 'bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400' : ''}" title="Go to Planner">
                                    ${icons.ClipboardList}
                                </button>
                                <button onclick="toggleDarkMode()" class="p-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                    ${state.isDarkMode ? icons.Sun : icons.Moon}
                                </button>
                                <button onclick="state.isSettingsOpen = !state.isSettingsOpen; render();" class="p-2 text-slate-600 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                    ${icons.Settings2}
                                </button>
                            </div>
                        </div>
                    </nav>

                    <main class="container mx-auto px-4 py-8">
                        ${mainContent}
                    </main>

                    ${state.isSettingsOpen ? `
                    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4" onclick="if(event.target === this) { state.isSettingsOpen = false; render(); }">
                        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-md w-full max-h-[80vh] overflow-y-auto" onclick="event.stopPropagation()">
                            <div class="p-6 border-b border-slate-100 dark:border-slate-800 flex items-center justify-between sticky top-0 bg-white dark:bg-slate-900 z-10">
                                <h2 class="text-xl font-bold text-slate-900 dark:text-white">Settings</h2>
                                <button onclick="state.isSettingsOpen = false; render();" class="p-2 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-colors">
                                    ${icons.X}
                                </button>
                            </div>
                            
                            <div class="p-6 space-y-6">
                                <div>
                                    <label class="block text-sm font-bold mb-3 text-slate-900 dark:text-white">Completion Sound</label>
                                    <div class="space-y-2">
                                        <button 
                                            onclick="handleSoundChange('chime')" 
                                            class="w-full p-4 rounded-xl border-2 transition-all text-left flex items-center gap-3 ${state.selectedSound === 'chime' ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-950/30' : 'border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'}"
                                        >
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${state.selectedSound === 'chime' ? 'border-indigo-600' : 'border-slate-300 dark:border-slate-600'}">
                                                ${state.selectedSound === 'chime' ? '<div class="w-3 h-3 rounded-full bg-indigo-600"></div>' : ''}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-2xl">üéµ</span>
                                                    <span class="font-bold text-slate-900 dark:text-white">Chime</span>
                                                </div>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Gentle and calming tone</p>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onclick="handleSoundChange('bell')" 
                                            class="w-full p-4 rounded-xl border-2 transition-all text-left flex items-center gap-3 ${state.selectedSound === 'bell' ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-950/30' : 'border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'}"
                                        >
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${state.selectedSound === 'bell' ? 'border-indigo-600' : 'border-slate-300 dark:border-slate-600'}">
                                                ${state.selectedSound === 'bell' ? '<div class="w-3 h-3 rounded-full bg-indigo-600"></div>' : ''}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-2xl">üîî</span>
                                                    <span class="font-bold text-slate-900 dark:text-white">Bell</span>
                                                </div>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Clear and pleasant ring</p>
                                            </div>
                                        </button>
                                        
                                        <button 
                                            onclick="handleSoundChange('alert')" 
                                            class="w-full p-4 rounded-xl border-2 transition-all text-left flex items-center gap-3 ${state.selectedSound === 'alert' ? 'border-indigo-600 bg-indigo-50 dark:bg-indigo-950/30' : 'border-slate-200 dark:border-slate-700 hover:border-slate-300 dark:hover:border-slate-600'}"
                                        >
                                            <div class="w-5 h-5 rounded-full border-2 flex items-center justify-center ${state.selectedSound === 'alert' ? 'border-indigo-600' : 'border-slate-300 dark:border-slate-600'}">
                                                ${state.selectedSound === 'alert' ? '<div class="w-3 h-3 rounded-full bg-indigo-600"></div>' : ''}
                                            </div>
                                            <div class="flex-1">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-2xl">‚è∞</span>
                                                    <span class="font-bold text-slate-900 dark:text-white">Alert</span>
                                                </div>
                                                <p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Sharp and attention-getting</p>
                                            </div>
                                        </button>
                                    </div>
                                    <p class="text-xs text-slate-500 dark:text-slate-400 mt-3">Click to preview and select</p>
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2 text-slate-900 dark:text-white">Volume: ${Math.round(state.volume * 100)}%</label>
                                    <input type="range" min="0" max="1" step="0.1" value="${state.volume}" oninput="state.volume = parseFloat(this.value); saveToLocalStorage(); render();" class="w-full" />
                                </div>

                                <div>
                                    <label class="block text-sm font-bold mb-2 text-slate-900 dark:text-white">Default Break Duration</label>
                                    <input type="number" value="${state.defaultBreakDuration}" onchange="state.defaultBreakDuration = parseInt(this.value) || 5; saveToLocalStorage(); render();" class="w-full p-3 bg-slate-50 dark:bg-slate-800 rounded-xl border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white" />
                                </div>

                                <div class="flex items-center justify-between">
                                    <label class="text-sm font-bold text-slate-900 dark:text-white">Confirm Before Delete</label>
                                    <button onclick="state.confirmBeforeDelete = !state.confirmBeforeDelete; saveToLocalStorage(); render();" class="w-12 h-6 rounded-full transition-colors ${state.confirmBeforeDelete ? 'bg-indigo-600' : 'bg-slate-300'}">
                                        <div class="w-5 h-5 bg-white rounded-full transform transition-transform ${state.confirmBeforeDelete ? 'translate-x-6' : 'translate-x-1'}"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    ` : ''}

                    ${state.deleteConfirmation ? `
                    <div class="fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div class="bg-white dark:bg-slate-900 rounded-3xl shadow-2xl max-w-sm w-full p-6">
                            <h2 class="text-xl font-bold mb-4 text-slate-900 dark:text-white">Confirm Delete</h2>
                            <p class="text-slate-600 dark:text-slate-300 mb-6">Are you sure you want to delete ${Array.isArray(state.deleteConfirmation) ? state.deleteConfirmation.length + ' activities' : 'this activity'}?</p>
                            <div class="flex gap-3">
                                <button onclick="cancelDelete()" class="flex-1 px-4 py-2 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 font-bold rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 transition-all">
                                    Cancel
                                </button>
                                <button onclick="confirmDelete()" class="flex-1 px-4 py-2 bg-red-600 text-white font-bold rounded-xl hover:bg-red-700 transition-all">
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                </div>
            `;
            
            requestAnimationFrame(() => {
                const newScrollContainer = document.getElementById('activities-scroll-container');
                if (newScrollContainer && scrollTop > 0) {
                    newScrollContainer.scrollTop = scrollTop;
                }
                
                if (activeId && activeId.startsWith('activity-input-')) {
                    const input = document.getElementById(activeId);
                    if (input) {
                        input.focus();
                        if (typeof cursorPosition === 'number') {
                            input.setSelectionRange(cursorPosition, cursorPosition);
                        }
                    }
                }
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadFromLocalStorage();
            
            state.audioElement = new Audio(AUDIO_URLS[state.selectedSound]);
            state.audioElement.volume = state.volume;
            
            state.insights = generateInsights();
            
            setInterval(() => {
                state.now = new Date();
                if (!isTyping) {
                    render();
                }
            }, 1000);
            
            if (state.isDarkMode) {
                document.documentElement.classList.add('dark');
            }
            
            render();
        });

        // Make functions available globally
        window.addActivity = addActivity;
        window.addBreak = addBreak;
        window.updateActivity = updateActivity;
        window.handleActivityNameChange = handleActivityNameChange;
        window.handleInputFocus = handleInputFocus;
        window.handleInputKeydown = handleInputKeydown;
        window.handleInputBlur = handleInputBlur;
        window.updateInsightsDisplay = updateInsightsDisplay;
        window.handleFileImport = handleFileImport;
        window.deleteActivity = deleteActivity;
        window.requestDelete = requestDelete;
        window.confirmDelete = confirmDelete;
        window.cancelDelete = cancelDelete;
        window.toggleSelect = toggleSelect;
        window.toggleSelectAll = toggleSelectAll;
        window.startSession = startSession;
        window.togglePause = togglePause;
        window.resetSession = resetSession;
        window.skipActivity = skipActivity;
        window.playSound = playSound;
        window.handleSoundChange = handleSoundChange;
        window.loadPreset = loadPreset;
        window.toggleDarkMode = toggleDarkMode;
        window.navigateToPlanner = navigateToPlanner;
        window.navigateToTimer = navigateToTimer;
        window.handleSort = handleSort;
        window.state = state;
    </script>
</body>
</html>
